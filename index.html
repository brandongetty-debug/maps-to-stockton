<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Maps to Stockton — Brandon Getty</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    background: #0a0a0a;
    color: #e8e4df;
    overflow: hidden;
    height: 100vh;
    width: 100vw;
  }

  /* ── Map ── */
  #map { position: absolute; inset: 0; z-index: 1; }

  /* ── Title overlay ── */
  #title-overlay {
    position: absolute;
    top: 24px;
    left: 80px;
    z-index: 1000;
    transition: opacity 0.4s ease;
  }
  #title-overlay h1 {
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-weight: 500;
    font-size: 28px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: #fff;
    text-shadow: 0 2px 12px rgba(0,0,0,0.7);
    line-height: 1.2;
  }
  #title-overlay .subtitle {
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-weight: 300;
    font-size: 12px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: rgba(255,255,255,0.6);
    text-shadow: 0 1px 8px rgba(0,0,0,0.7);
    margin-top: 4px;
  }
  #title-overlay .subtitle a {
    color: rgba(255,255,255,0.6);
    text-decoration: none;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    transition: all 0.2s;
  }
  #title-overlay .subtitle a:hover {
    color: rgba(255,255,255,0.9);
    border-color: rgba(255,255,255,0.5);
  }

  /* ── Control panel ── */
  #controls {
    position: absolute;
    top: 90px;
    left: 24px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 2px;
    width: 52px;
  }
  .ctrl-btn {
    width: 52px;
    height: 38px;
    background: rgba(17,17,17,0.88);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.08);
    color: rgba(255,255,255,0.5);
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-size: 11px;
    font-weight: 400;
    letter-spacing: 0.04em;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  .ctrl-btn:first-child { border-radius: 6px 6px 0 0; }
  .ctrl-btn:hover { color: rgba(255,255,255,0.85); background: rgba(30,30,30,0.92); }
  .ctrl-btn.active { color: #fff; background: rgba(255,255,255,0.12); }
  .ctrl-btn .icon { font-size: 16px; line-height: 1; }

  .ctrl-sep {
    height: 6px;
  }

  .ctrl-zoom { font-size: 18px; font-weight: 300; }

  /* Years dropdown */
  #years-panel {
    display: none;
    flex-direction: column;
    gap: 0;
    margin-top: 0;
  }
  #years-panel.open { display: flex; }
  .year-btn {
    width: 52px;
    height: 32px;
    background: rgba(17,17,17,0.88);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.08);
    border-top: none;
    color: rgba(255,255,255,0.4);
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-size: 10px;
    font-weight: 400;
    letter-spacing: 0.04em;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  .year-btn:hover { color: rgba(255,255,255,0.7); background: rgba(30,30,30,0.92); }
  .year-btn.active { color: #fff; background: rgba(255,255,255,0.12); }

  .ctrl-last { border-radius: 0 0 6px 6px; }

  /* ── Photo overlay ── */
  #overlay-backdrop {
    position: fixed;
    inset: 0;
    z-index: 2000;
    background: rgba(0,0,0,0.82);
    backdrop-filter: blur(4px);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.35s ease;
  }
  #overlay-backdrop.open { opacity: 1; pointer-events: auto; }

  #overlay {
    position: fixed;
    inset: 0;
    z-index: 2001;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.35s ease;
  }
  #overlay.open { opacity: 1; pointer-events: auto; }

  #overlay-content {
    width: 82vw;
    max-width: 1100px;
    height: 85vh;
    display: flex;
    flex-direction: column;
    position: relative;
  }

  /* Tab switcher */
  #overlay-tabs {
    display: flex;
    justify-content: center;
    gap: 0;
    flex-shrink: 0;
    margin-bottom: 12px;
  }
  .overlay-tab {
    padding: 10px 24px;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-weight: 400;
    font-size: 11px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: rgba(255,255,255,0.35);
    cursor: pointer;
    border: none;
    background: none;
    border-bottom: 2px solid transparent;
    transition: all 0.25s;
  }
  .overlay-tab:hover { color: rgba(255,255,255,0.7); }
  .overlay-tab.active { color: #fff; border-bottom-color: #fff; }

  /* Photo/SV views */
  #overlay-body {
    flex: 1;
    position: relative;
    overflow: hidden;
    border-radius: 4px;
  }
  .overlay-view {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
  }
  .overlay-view.active { opacity: 1; pointer-events: auto; }

  #photo-view {
    background: transparent;
  }
  #photo-view img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 2px;
    transition: opacity 0.2s ease;
  }
  #photo-view img.loading { opacity: 0.3; }

  #streetview-view {
    background: #0a0a0a;
    border-radius: 4px;
  }
  #streetview-frame { width: 100%; height: 100%; border: none; border-radius: 4px; }
  #streetview-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 40px;
    text-align: center;
  }
  #streetview-placeholder .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.3; }
  #streetview-placeholder p {
    font-size: 13px;
    color: rgba(255,255,255,0.35);
    line-height: 1.6;
    max-width: 300px;
  }

  /* Caption */
  #overlay-caption {
    text-align: center;
    padding: 16px 0 0;
    flex-shrink: 0;
  }
  #overlay-caption .location-name {
    font-size: 20px;
    font-weight: 500;
    color: #fff;
    letter-spacing: 0.02em;
    margin-bottom: 4px;
  }
  #overlay-caption .photo-date {
    font-size: 12px;
    font-weight: 300;
    letter-spacing: 0.08em;
    color: rgba(255,255,255,0.45);
  }
  #overlay-caption .photo-tags {
    font-size: 11px;
    font-weight: 300;
    color: rgba(255,255,255,0.2);
    margin-top: 6px;
  }
  #overlay-caption .tumblr-link {
    display: inline-block;
    margin-top: 8px;
    font-size: 11px;
    font-weight: 400;
    letter-spacing: 0.06em;
    color: rgba(255,255,255,0.3);
    text-decoration: none;
    border-bottom: 1px solid rgba(255,255,255,0.15);
    transition: all 0.2s;
  }
  #overlay-caption .tumblr-link:hover { color: rgba(255,255,255,0.6); border-color: rgba(255,255,255,0.3); }

  /* Close button */
  #overlay-close {
    position: absolute;
    top: -4px; right: -60px;
    z-index: 10;
    width: 40px; height: 40px;
    border-radius: 50%;
    border: none;
    background: rgba(255,255,255,0.08);
    color: rgba(255,255,255,0.6);
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  #overlay-close:hover { background: rgba(255,255,255,0.15); color: #fff; }

  /* Nav arrows */
  .overlay-nav {
    position: fixed;
    top: 50%;
    z-index: 2002;
    width: 48px; height: 48px;
    border-radius: 50%;
    border: none;
    background: rgba(255,255,255,0.06);
    color: rgba(255,255,255,0.5);
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transform: translateY(-50%);
    transition: all 0.2s;
  }
  .overlay-nav:hover { background: rgba(255,255,255,0.12); color: #fff; }
  #nav-prev { left: 20px; }
  #nav-next { right: 20px; }

  /* ── Custom markers ── */
  .photo-marker {
    width: 10px; height: 10px;
    border-radius: 50%;
    background: #d63031;
    border: 1.5px solid rgba(0,0,0,0.5);
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 1px 4px rgba(0,0,0,0.4), 0 0 6px rgba(214,48,49,0.4);
  }
  .photo-marker:hover {
    transform: scale(1.8);
    background: #ff4444;
    box-shadow: 0 0 12px rgba(255,68,68,0.6);
  }
  .photo-marker.active {
    background: #ff4444;
    transform: scale(2.2);
    box-shadow: 0 0 20px rgba(255,68,68,0.8), 0 0 40px rgba(255,68,68,0.3);
    animation: marker-pulse 1.5s ease-in-out infinite;
  }

  @keyframes marker-pulse {
    0%, 100% { box-shadow: 0 0 20px rgba(255,68,68,0.8), 0 0 40px rgba(255,68,68,0.3); transform: scale(2.2); }
    50% { box-shadow: 0 0 28px rgba(255,68,68,1), 0 0 56px rgba(255,68,68,0.5); transform: scale(2.6); }
  }

  /* Cluster styling */
  .marker-cluster {
    background: rgba(214,48,49,0.25) !important;
    border: 2px solid rgba(214,48,49,0.6) !important;
    border-radius: 50% !important;
  }
  .marker-cluster div {
    background: rgba(214,48,49,0.7) !important;
    color: #fff !important;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif !important;
    font-weight: 500 !important;
    font-size: 12px !important;
    width: 30px !important;
    height: 30px !important;
    margin-left: 0 !important;
    margin-top: 0 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    border-radius: 50% !important;
    line-height: 1 !important;
    text-align: center !important;
  }
  .marker-cluster-small {
    background: rgba(214,48,49,0.2) !important;
    width: 36px !important; height: 36px !important;
    display: flex !important; align-items: center !important; justify-content: center !important;
  }
  .marker-cluster-medium {
    background: rgba(214,48,49,0.3) !important;
    width: 42px !important; height: 42px !important;
    display: flex !important; align-items: center !important; justify-content: center !important;
  }
  .marker-cluster-large {
    background: rgba(214,48,49,0.4) !important;
    width: 48px !important; height: 48px !important;
    display: flex !important; align-items: center !important; justify-content: center !important;
  }

  /* Tooltip */
  .leaflet-tooltip.photo-tooltip {
    background: rgba(0,0,0,0.85);
    border: 1px solid rgba(255,255,255,0.1);
    color: #fff;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-size: 14px;
    padding: 6px 12px;
    border-radius: 4px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    backdrop-filter: blur(8px);
  }
  .leaflet-tooltip.photo-tooltip::before { border-top-color: rgba(0,0,0,0.85); }

  /* Hide default Leaflet controls */
  .leaflet-control-zoom { display: none !important; }
  .leaflet-control-layers { display: none !important; }
  .leaflet-control-attribution {
    background: rgba(0,0,0,0.5) !important;
    color: rgba(255,255,255,0.3) !important;
    font-size: 10px !important;
  }
  .leaflet-control-attribution a { color: rgba(255,255,255,0.4) !important; }

  /* Loading overlay */
  #loading {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: #0a0a0a;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: opacity 0.6s;
  }
  #loading.done { opacity: 0; pointer-events: none; }
  #loading h2 {
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-weight: 500;
    font-size: 24px;
    color: rgba(255,255,255,0.6);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }
  #loading p {
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-weight: 300;
    font-size: 12px;
    color: rgba(255,255,255,0.3);
  }

  @media (max-width: 700px) {
    #overlay-content { width: 95vw; height: 90vh; }
    #overlay-close { top: -48px; right: 0; }
    #title-overlay h1 { font-size: 20px; }
    #title-overlay { left: 60px; }
    #controls { top: 80px; left: 12px; width: 44px; }
    .ctrl-btn { width: 44px; height: 34px; font-size: 10px; }
    .year-btn { width: 44px; height: 28px; font-size: 9px; }
    .overlay-nav { width: 36px; height: 36px; font-size: 18px; }
    #nav-prev { left: 8px; }
    #nav-next { right: 8px; }
  }
</style>
</head>
<body>

<!-- Loading -->
<div id="loading">
  <h2>Maps to Stockton</h2>
  <p>Loading photographs...</p>
</div>

<!-- Title -->
<div id="title-overlay">
  <h1>Maps to Stockton</h1>
  <div class="subtitle">A project by <a href="https://brandongettyphoto.com" target="_blank" rel="noopener">Brandon Getty</a></div>
</div>

<!-- Control panel -->
<div id="controls">
  <button class="ctrl-btn ctrl-zoom" id="ctrl-zoom-in" title="Zoom in"><span class="icon">+</span></button>
  <button class="ctrl-btn ctrl-zoom" id="ctrl-zoom-out" title="Zoom out"><span class="icon">&minus;</span></button>

  <div class="ctrl-sep"></div>

  <button class="ctrl-btn" id="ctrl-theme" title="Toggle light/dark">
    <span class="icon" id="theme-icon">&#9788;</span>
  </button>

  <div class="ctrl-sep"></div>

  <button class="ctrl-btn" id="ctrl-years" title="Filter by year">Years</button>
  <div id="years-panel">
    <button class="year-btn active" data-year="all">All</button>
    <button class="year-btn" data-year="2010">2010</button>
    <button class="year-btn" data-year="2011">2011</button>
    <button class="year-btn" data-year="2012">2012</button>
    <button class="year-btn" data-year="2013">2013</button>
    <button class="year-btn" data-year="2014">2014</button>
    <button class="year-btn" data-year="2015">2015</button>
    <button class="year-btn" data-year="2019">2019</button>
    <button class="year-btn" data-year="2022">2022</button>
  </div>
  <button class="ctrl-btn" id="ctrl-oldest" title="Go to oldest">Oldest</button>
  <button class="ctrl-btn" id="ctrl-newest" title="Go to newest">Newest</button>
  <button class="ctrl-btn ctrl-last" id="ctrl-random" title="Random photo">Random</button>
</div>

<!-- Map -->
<div id="map"></div>

<!-- Overlay backdrop -->
<div id="overlay-backdrop"></div>

<!-- Photo overlay -->
<div id="overlay">
  <div id="overlay-content">
    <button id="overlay-close" aria-label="Close">&#x2715;</button>
    <div id="overlay-tabs">
      <button class="overlay-tab active" data-tab="photo">Photograph · Then</button>
      <button class="overlay-tab" data-tab="streetview">Street View · Now</button>
    </div>
    <div id="overlay-body">
      <div id="photo-view" class="overlay-view active">
        <img id="panel-photo" src="" alt="" />
      </div>
      <div id="streetview-view" class="overlay-view">
        <div id="streetview-placeholder">
          <div class="icon">&#x1F6F0;</div>
          <p id="streetview-msg">
            Street View requires a Google Maps API key.<br><br>
            Set the <code>GOOGLE_API_KEY</code> variable in source to enable.
          </p>
        </div>
        <iframe id="streetview-frame" style="display:none;" loading="lazy"></iframe>
      </div>
    </div>
    <div id="overlay-caption">
      <div class="location-name" id="caption-location"></div>
      <div class="photo-date" id="caption-date"></div>
      <div class="photo-tags" id="caption-tags"></div>
      <a class="tumblr-link" id="caption-tumblr" href="#" target="_blank" rel="noopener">View on Tumblr</a>
    </div>
  </div>
  <button class="overlay-nav" id="nav-prev" aria-label="Previous photo">&#x2039;</button>
  <button class="overlay-nav" id="nav-next" aria-label="Next photo">&#x203A;</button>
</div>

<script>
// ═══════════════════════════════════════════
//  CONFIG
// ═══════════════════════════════════════════
const GOOGLE_API_KEY = 'AIzaSyB2y9l_4rZzinNZoH5SmijIK6NPpO3DCcs';

// ═══════════════════════════════════════════
//  PHOTO DATA (loaded from photos.json)
// ═══════════════════════════════════════════
let PHOTOS = [];
let appInitialized = false;

function initializeApp() {
  if (appInitialized) return;
  appInitialized = true;

// ═══════════════════════════════════════════
//  MAP SETUP
// ═══════════════════════════════════════════
const STOCKTON = [37.9577, -121.2908];

const darkLayer = L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
  { attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 19 }
);
const lightLayer = L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
  { attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 19 }
);

let isDark = true;

const map = L.map('map', {
  center: STOCKTON,
  zoom: 14,
  layers: [darkLayer],
  zoomControl: false,
});

// ═══════════════════════════════════════════
//  CONTROLS
// ═══════════════════════════════════════════

// Zoom
document.getElementById('ctrl-zoom-in').addEventListener('click', () => map.zoomIn());
document.getElementById('ctrl-zoom-out').addEventListener('click', () => map.zoomOut());

// Theme toggle
const themeIcon = document.getElementById('theme-icon');
document.getElementById('ctrl-theme').addEventListener('click', () => {
  if (isDark) {
    map.removeLayer(darkLayer);
    map.addLayer(lightLayer);
    themeIcon.innerHTML = '&#9790;'; // moon
  } else {
    map.removeLayer(lightLayer);
    map.addLayer(darkLayer);
    themeIcon.innerHTML = '&#9788;'; // sun
  }
  isDark = !isDark;
});

// Years dropdown
const yearsPanel = document.getElementById('years-panel');
document.getElementById('ctrl-years').addEventListener('click', () => {
  yearsPanel.classList.toggle('open');
});

// ═══════════════════════════════════════════
//  MARKERS & CLUSTERING
// ═══════════════════════════════════════════
const clusterGroup = L.markerClusterGroup({
  maxClusterRadius: 35,
  spiderfyOnMaxZoom: true,
  showCoverageOnHover: false,
  zoomToBoundsOnClick: true,
  iconCreateFunction: function(cluster) {
    const count = cluster.getChildCount();
    let size = 'small';
    if (count > 10) size = 'medium';
    if (count > 30) size = 'large';
    return L.divIcon({
      html: '<div>' + count + '</div>',
      className: 'marker-cluster marker-cluster-' + size,
      iconSize: L.point(36, 36)
    });
  }
});

let activeMarkerEl = null;
const markerMap = new Map();
let visiblePhotos = [...PHOTOS];

function createMarkers(photos) {
  clusterGroup.clearLayers();
  markerMap.clear();

  photos.forEach(photo => {
    const icon = L.divIcon({
      className: '',
      html: '<div class="photo-marker" data-id="' + photo.id + '"></div>',
      iconSize: [10, 10],
      iconAnchor: [5, 5]
    });

    const marker = L.marker([photo.lat, photo.lng], { icon })
      .bindTooltip(photo.title + (photo.date ? ', ' + photo.date : ''), {
        className: 'photo-tooltip',
        direction: 'top',
        offset: [0, -8]
      });

    marker.on('click', () => openOverlay(photo));
    clusterGroup.addLayer(marker);
    markerMap.set(photo.id, { marker, photo });
  });

  map.addLayer(clusterGroup);
}

// ═══════════════════════════════════════════
//  YEAR FILTER
// ═══════════════════════════════════════════
function getYear(dateStr) {
  if (!dateStr) return null;
  const match = dateStr.match(/(\d{4})/);
  return match ? match[1] : null;
}

function getYearNum(dateStr) {
  const y = getYear(dateStr);
  return y ? parseInt(y) : 9999;
}

document.querySelectorAll('.year-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.year-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const year = btn.dataset.year;
    if (year === 'all') {
      visiblePhotos = [...PHOTOS];
    } else {
      visiblePhotos = PHOTOS.filter(p => getYear(p.date) === year);
    }
    createMarkers(visiblePhotos);
    closeOverlay();
  });
});

// Oldest / Newest / Random
document.getElementById('ctrl-oldest').addEventListener('click', () => {
  if (visiblePhotos.length === 0) return;
  const sorted = [...visiblePhotos].sort((a, b) => getYearNum(a.date) - getYearNum(b.date));
  openOverlay(sorted[0]);
});

document.getElementById('ctrl-newest').addEventListener('click', () => {
  if (visiblePhotos.length === 0) return;
  const sorted = [...visiblePhotos].sort((a, b) => getYearNum(b.date) - getYearNum(a.date));
  openOverlay(sorted[0]);
});

document.getElementById('ctrl-random').addEventListener('click', () => {
  if (visiblePhotos.length === 0) return;
  const idx = Math.floor(Math.random() * visiblePhotos.length);
  openOverlay(visiblePhotos[idx]);
});

// ═══════════════════════════════════════════
//  OVERLAY
// ═══════════════════════════════════════════
const backdrop = document.getElementById('overlay-backdrop');
const overlay = document.getElementById('overlay');
const panelPhoto = document.getElementById('panel-photo');
const captionLocation = document.getElementById('caption-location');
const captionDate = document.getElementById('caption-date');
const captionTags = document.getElementById('caption-tags');
const captionTumblr = document.getElementById('caption-tumblr');
const streetviewFrame = document.getElementById('streetview-frame');
const streetviewPlaceholder = document.getElementById('streetview-placeholder');

let currentPhoto = null;

function highlightMarker(photo) {
  if (activeMarkerEl) activeMarkerEl.classList.remove('active');
  activeMarkerEl = null;
  const entry = markerMap.get(photo.id);
  if (entry) {
    // Ensure the marker is visible (not inside a cluster)
    clusterGroup.zoomToShowLayer(entry.marker, () => {
      const el = entry.marker.getElement();
      if (el) {
        const dot = el.querySelector('.photo-marker');
        if (dot) { dot.classList.add('active'); activeMarkerEl = dot; }
      }
    });
  }
}

function openOverlay(photo, opts = {}) {
  const isNav = opts.fromNav || false;
  currentPhoto = photo;

  // Highlight marker with pulse
  highlightMarker(photo);

  // Photo — fade out during load
  panelPhoto.classList.add('loading');
  const newImg = new Image();
  newImg.onload = () => {
    panelPhoto.src = photo.imageUrl;
    panelPhoto.alt = photo.title;
    panelPhoto.classList.remove('loading');
  };
  newImg.onerror = () => {
    panelPhoto.src = photo.imageUrl;
    panelPhoto.classList.remove('loading');
  };
  newImg.src = photo.imageUrl;

  // Caption
  captionLocation.textContent = photo.title;
  captionDate.textContent = photo.date || '';
  captionTags.textContent = photo.tags.length ? photo.tags.map(t => '#' + t).join('  ') : '';
  if (photo.tumblrUrl) {
    captionTumblr.href = photo.tumblrUrl;
    captionTumblr.style.display = 'inline-block';
  } else {
    captionTumblr.style.display = 'none';
  }

  // Street View
  if (!isNav) {
    if (GOOGLE_API_KEY) {
      streetviewPlaceholder.style.display = 'none';
      streetviewFrame.style.display = 'block';
      const h = photo.heading != null ? photo.heading : 0;
      const p = photo.pitch != null ? photo.pitch : 0;
      const f = photo.fov != null ? photo.fov : 90;
      streetviewFrame.src = 'https://www.google.com/maps/embed/v1/streetview?key=' + GOOGLE_API_KEY + '&location=' + photo.lat + ',' + photo.lng + '&heading=' + h + '&pitch=' + p + '&fov=' + f;
    } else {
      streetviewFrame.style.display = 'none';
      streetviewPlaceholder.style.display = 'flex';
    }
  }

  // Open overlay
  if (!backdrop.classList.contains('open')) {
    switchTab('photo');
  }
  backdrop.classList.add('open');
  overlay.classList.add('open');

  // Pan map to marker
  if (!isNav) {
    map.panTo([photo.lat, photo.lng], { animate: true });
  } else {
    clearTimeout(openOverlay._panTimer);
    openOverlay._panTimer = setTimeout(() => {
      map.panTo([photo.lat, photo.lng], { animate: true, duration: 0.3 });
      // Reload street view after settling
      if (GOOGLE_API_KEY && currentPhoto) {
        streetviewPlaceholder.style.display = 'none';
        streetviewFrame.style.display = 'block';
        const h2 = currentPhoto.heading != null ? currentPhoto.heading : 0;
        const p2 = currentPhoto.pitch != null ? currentPhoto.pitch : 0;
        const f2 = currentPhoto.fov != null ? currentPhoto.fov : 90;
        streetviewFrame.src = 'https://www.google.com/maps/embed/v1/streetview?key=' + GOOGLE_API_KEY + '&location=' + currentPhoto.lat + ',' + currentPhoto.lng + '&heading=' + h2 + '&pitch=' + p2 + '&fov=' + f2;
      }
    }, 400);
  }
}

function closeOverlay() {
  backdrop.classList.remove('open');
  overlay.classList.remove('open');
  if (activeMarkerEl) { activeMarkerEl.classList.remove('active'); activeMarkerEl = null; }
  currentPhoto = null;
  streetviewFrame.src = '';
}

// Close events
document.getElementById('overlay-close').addEventListener('click', closeOverlay);
backdrop.addEventListener('click', closeOverlay);
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeOverlay(); });

// Nav
function navigate(dir) {
  if (!currentPhoto) return;
  const idx = visiblePhotos.findIndex(p => p.id === currentPhoto.id);
  if (idx === -1) return;
  const next = (idx + dir + visiblePhotos.length) % visiblePhotos.length;
  openOverlay(visiblePhotos[next], { fromNav: true });
}

document.getElementById('nav-prev').addEventListener('click', e => { e.stopPropagation(); navigate(-1); });
document.getElementById('nav-next').addEventListener('click', e => { e.stopPropagation(); navigate(1); });
document.addEventListener('keydown', e => {
  if (!currentPhoto) return;
  if (e.key === 'ArrowRight' || e.key === 'ArrowDown') { e.preventDefault(); navigate(1); }
  if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') { e.preventDefault(); navigate(-1); }
});

// Tabs
function switchTab(name) {
  document.querySelectorAll('.overlay-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === name));
  document.querySelectorAll('.overlay-view').forEach(v => v.classList.toggle('active', v.id === name + '-view'));
}
document.querySelectorAll('.overlay-tab').forEach(t => t.addEventListener('click', () => switchTab(t.dataset.tab)));

// ═══════════════════════════════════════════
//  INIT
// ═══════════════════════════════════════════
createMarkers(PHOTOS);
visiblePhotos = [...PHOTOS];

// Open a random photo on first visit
if (PHOTOS.length > 0) {
  const randomIdx = Math.floor(Math.random() * PHOTOS.length);
  setTimeout(() => openOverlay(PHOTOS[randomIdx]), 1200);
}

  // Dismiss loading
  setTimeout(() => document.getElementById('loading').classList.add('done'), 800);
  setTimeout(() => document.getElementById('loading').remove(), 1500);
}

fetch('photos.json')
  .then(r => r.json())
  .then(data => {
    PHOTOS = data;
    initializeApp();
  })
  .catch(err => {
    console.error('Failed to load photo data:', err);
    setTimeout(() => document.getElementById('loading').classList.add('done'), 800);
    setTimeout(() => document.getElementById('loading').remove(), 1500);
  });

</script>
</body>
</html>
