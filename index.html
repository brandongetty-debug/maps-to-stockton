<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Maps to Stockton — Brandon Getty</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    background: #0a0a0a;
    color: #e8e4df;
    overflow: hidden;
    height: 100vh;
    width: 100vw;
  }

  /* ── Map ── */
  #map {
    position: absolute;
    top: 0; left: 0; bottom: 0;
    width: 100%;
    z-index: 1;
    transition: width 0.45s cubic-bezier(0.16, 1, 0.3, 1);
  }
  body.panel-open #map { width: 45%; }

  /* ── Title overlay ── */
  #title-overlay {
    position: absolute;
    top: 24px;
    left: 100px;
    z-index: 1000;
    pointer-events: none;
    transition: opacity 0.4s ease;
  }
  #title-overlay h1 {
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-weight: 500;
    font-size: 28px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: #fff;
    text-shadow: 0 2px 12px rgba(0,0,0,0.7);
    line-height: 1.2;
  }
  #title-overlay .subtitle {
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-weight: 300;
    font-size: 12px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: rgba(255,255,255,0.6);
    text-shadow: 0 1px 8px rgba(0,0,0,0.7);
    margin-top: 4px;
  }
  #title-overlay .subtitle a {
    pointer-events: auto;
    color: #5cbdb9;
    text-decoration: none;
    border-bottom: 1px solid rgba(92,189,185,0.35);
    transition: all 0.2s;
  }
  #title-overlay .subtitle a:hover {
    color: #7dd3d0;
    border-color: rgba(125,211,208,0.6);
  }

  /* ── Control panel ── */
  #controls {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    left: 24px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 2px;
    width: 68px;
  }
  .ctrl-btn {
    width: 68px;
    height: 38px;
    background: rgba(17,17,17,0.88);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.08);
    color: rgba(255,255,255,0.5);
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-size: 11px;
    font-weight: 400;
    letter-spacing: 0.04em;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  .ctrl-btn:first-child { border-radius: 6px 6px 0 0; }
  .ctrl-btn:hover { color: rgba(255,255,255,0.85); background: rgba(30,30,30,0.92); }
  .ctrl-btn.active { color: #fff; background: rgba(255,255,255,0.12); }

  .ctrl-sep { height: 6px; }

  .ctrl-zoom {
    height: 46px;
    font-size: 26px;
    font-weight: 300;
    color: rgba(255,255,255,0.7);
  }
  .ctrl-zoom:hover { color: #fff; }

  .ctrl-theme-icon {
    font-size: 20px;
    line-height: 1;
  }

  /* Info tooltip */
  .info-tooltip-wrap {
    position: relative;
  }
  .info-card {
    display: none;
    position: absolute;
    left: calc(100% + 12px);
    top: 50%;
    transform: translateY(-50%);
    width: 240px;
    background: rgba(17,17,17,0.95);
    backdrop-filter: blur(16px);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    padding: 16px 18px;
    z-index: 2000;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  }
  .info-card.visible { display: block; }
  .info-card p {
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-size: 13px;
    font-weight: 300;
    line-height: 1.6;
    color: rgba(255,255,255,0.7);
    margin: 0;
  }
  .info-card p + p {
    margin-top: 10px;
    font-size: 11px;
    color: rgba(255,255,255,0.4);
    font-style: italic;
  }
  /* Arrow pointing left toward the button */
  .info-card::before {
    content: '';
    position: absolute;
    left: -6px;
    top: 50%;
    transform: translateY(-50%) rotate(45deg);
    width: 10px;
    height: 10px;
    background: rgba(17,17,17,0.95);
    border-left: 1px solid rgba(255,255,255,0.1);
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  /* Years dropdown */
  #years-panel {
    display: none;
    flex-direction: column;
    gap: 0;
  }
  #years-panel.open { display: flex; }
  .year-btn {
    width: 68px;
    height: 32px;
    background: rgba(17,17,17,0.88);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.08);
    border-top: none;
    color: rgba(255,255,255,0.4);
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-size: 10px;
    font-weight: 400;
    letter-spacing: 0.04em;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  .year-btn:hover { color: rgba(255,255,255,0.7); background: rgba(30,30,30,0.92); }
  .year-btn.active { color: #fff; background: rgba(255,255,255,0.12); }

  .ctrl-last { border-radius: 0 0 6px 6px; }

  /* ── Photo panel (split screen) ── */
  #photo-panel {
    position: absolute;
    top: 0; right: 0;
    width: 55%;
    height: 100vh;
    z-index: 2000;
    background: #111;
    transform: translateX(100%);
    transition: transform 0.45s cubic-bezier(0.16, 1, 0.3, 1);
    display: flex;
    flex-direction: column;
    box-shadow: -4px 0 40px rgba(0,0,0,0.6);
    overflow: hidden;
  }
  #photo-panel.open { transform: translateX(0); }

  /* Close button */
  #panel-close {
    position: absolute;
    top: 14px; left: 14px;
    z-index: 10;
    width: 36px; height: 36px;
    border-radius: 50%;
    border: none;
    background: rgba(255,255,255,0.06);
    color: rgba(255,255,255,0.5);
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  #panel-close:hover { background: rgba(255,255,255,0.12); color: #fff; }

  /* Nav arrows */
  .panel-nav {
    position: absolute;
    top: 50%;
    z-index: 10;
    width: 44px; height: 44px;
    border-radius: 50%;
    border: none;
    background: rgba(0,0,0,0.4);
    color: rgba(255,255,255,0.6);
    font-size: 22px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transform: translateY(-50%);
    transition: all 0.2s;
    backdrop-filter: blur(8px);
  }
  .panel-nav:hover { background: rgba(0,0,0,0.6); color: #fff; }
  #nav-prev { left: 14px; }
  #nav-next { right: 14px; }

  /* Tab switcher */
  #panel-tabs {
    display: flex;
    background: #161616;
    border-bottom: 1px solid #2a2a2a;
    flex-shrink: 0;
  }
  .panel-tab {
    flex: 1;
    padding: 14px 0;
    text-align: center;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-weight: 400;
    font-size: 11px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: rgba(255,255,255,0.35);
    cursor: pointer;
    border: none;
    border-bottom: 2px solid transparent;
    transition: all 0.25s;
    background: none;
  }
  .panel-tab:hover { color: rgba(255,255,255,0.7); }
  .panel-tab.active { color: #fff; border-bottom-color: #fff; }

  /* Panel body */
  #panel-body {
    flex: 1;
    overflow: hidden;
    position: relative;
  }
  .panel-view {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
    overflow-y: auto;
  }
  .panel-view.active { opacity: 1; pointer-events: auto; }

  /* Photo view */
  #photo-view {
    align-items: center;
    justify-content: center;
    padding: 24px;
    background: #0e0e0e;
  }
  #photo-view img {
    max-width: 100%;
    max-height: 65vh;
    object-fit: contain;
    border-radius: 2px;
    transition: opacity 0.2s ease;
  }
  #photo-view img.loading { opacity: 0.3; }

  /* Caption */
  #photo-caption {
    margin-top: 20px;
    text-align: center;
    padding-bottom: 20px;
  }
  #photo-caption .location-name {
    font-size: 20px;
    font-weight: 500;
    color: #fff;
    letter-spacing: 0.02em;
    margin-bottom: 4px;
  }
  #photo-caption .photo-date {
    font-size: 12px;
    font-weight: 300;
    letter-spacing: 0.08em;
    color: rgba(255,255,255,0.45);
  }
  #photo-caption .photo-tags {
    font-size: 11px;
    font-weight: 300;
    color: rgba(255,255,255,0.2);
    margin-top: 6px;
  }
  #photo-caption .tumblr-link {
    display: inline-block;
    margin-top: 10px;
    font-size: 11px;
    font-weight: 400;
    letter-spacing: 0.06em;
    color: rgba(255,255,255,0.3);
    text-decoration: none;
    border-bottom: 1px solid rgba(255,255,255,0.15);
    transition: all 0.2s;
  }
  #photo-caption .tumblr-link:hover { color: rgba(255,255,255,0.6); border-color: rgba(255,255,255,0.3); }

  /* Street View */
  #streetview-view { background: #0a0a0a; }
  #streetview-frame { width: 100%; height: 100%; border: none; }
  #streetview-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 40px;
    text-align: center;
  }
  #streetview-placeholder .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.3; }
  #streetview-placeholder p {
    font-size: 13px;
    color: rgba(255,255,255,0.35);
    line-height: 1.6;
    max-width: 300px;
  }

  /* ── Custom markers ── */
  .photo-marker {
    width: 10px; height: 10px;
    border-radius: 50%;
    background: #d63031;
    border: 1.5px solid rgba(0,0,0,0.5);
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 1px 4px rgba(0,0,0,0.4), 0 0 6px rgba(214,48,49,0.4);
  }
  .photo-marker:hover {
    transform: scale(1.8);
    background: #ff4444;
    box-shadow: 0 0 12px rgba(255,68,68,0.6);
  }
  .photo-marker.active {
    background: #ff4444;
    transform: scale(2.2);
    box-shadow: 0 0 20px rgba(255,68,68,0.8), 0 0 40px rgba(255,68,68,0.3);
    animation: marker-pulse 1.5s ease-in-out infinite;
  }

  @keyframes marker-pulse {
    0%, 100% { box-shadow: 0 0 20px rgba(255,68,68,0.8), 0 0 40px rgba(255,68,68,0.3); transform: scale(2.2); }
    50% { box-shadow: 0 0 28px rgba(255,68,68,1), 0 0 56px rgba(255,68,68,0.5); transform: scale(2.6); }
  }

  /* Cluster styling */
  .marker-cluster {
    background: rgba(214,48,49,0.25) !important;
    border: 2px solid rgba(214,48,49,0.6) !important;
    border-radius: 50% !important;
  }
  .marker-cluster div {
    background: rgba(214,48,49,0.7) !important;
    color: #fff !important;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif !important;
    font-weight: 500 !important;
    font-size: 12px !important;
    width: 30px !important; height: 30px !important;
    margin-left: 0 !important; margin-top: 0 !important;
    display: flex !important; align-items: center !important; justify-content: center !important;
    border-radius: 50% !important; line-height: 1 !important; text-align: center !important;
  }
  .marker-cluster-small {
    background: rgba(214,48,49,0.2) !important;
    width: 36px !important; height: 36px !important;
    display: flex !important; align-items: center !important; justify-content: center !important;
  }
  .marker-cluster-medium {
    background: rgba(214,48,49,0.3) !important;
    width: 42px !important; height: 42px !important;
    display: flex !important; align-items: center !important; justify-content: center !important;
  }
  .marker-cluster-large {
    background: rgba(214,48,49,0.4) !important;
    width: 48px !important; height: 48px !important;
    display: flex !important; align-items: center !important; justify-content: center !important;
  }

  /* Tooltip */
  .leaflet-tooltip.photo-tooltip {
    background: rgba(0,0,0,0.85);
    border: 1px solid rgba(255,255,255,0.1);
    color: #fff;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-size: 14px;
    padding: 6px 12px;
    border-radius: 4px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    backdrop-filter: blur(8px);
  }
  .leaflet-tooltip.photo-tooltip::before { border-top-color: rgba(0,0,0,0.85); }

  /* Hide default Leaflet controls */
  .leaflet-control-zoom { display: none !important; }
  .leaflet-control-layers { display: none !important; }
  .leaflet-control-attribution {
    background: rgba(0,0,0,0.5) !important;
    color: rgba(255,255,255,0.3) !important;
    font-size: 10px !important;
  }
  .leaflet-control-attribution a { color: rgba(255,255,255,0.4) !important; }

  /* Loading overlay */
  #loading {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: #0a0a0a;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: opacity 0.6s;
  }
  #loading.done { opacity: 0; pointer-events: none; }
  #loading h2 {
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-weight: 500;
    font-size: 24px;
    color: rgba(255,255,255,0.6);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }
  #loading p {
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-weight: 300;
    font-size: 12px;
    color: rgba(255,255,255,0.3);
  }

  @media (max-width: 700px) {
    #photo-panel { width: 100vw; }
    body.panel-open #map { width: 0; }
    #title-overlay h1 { font-size: 20px; }
    #title-overlay { left: 76px; }
    #controls { top: 50%; left: 12px; width: 56px; }
    .ctrl-btn { width: 56px; height: 34px; font-size: 10px; }
    .ctrl-zoom { height: 40px; font-size: 22px; }
    .year-btn { width: 56px; height: 28px; font-size: 9px; }
  }
</style>
</head>
<body>

<!-- Loading -->
<div id="loading">
  <h2>Maps to Stockton</h2>
  <p>Loading photographs...</p>
</div>

<!-- Title -->
<div id="title-overlay">
  <h1>Maps to Stockton</h1>
  <div class="subtitle">A project by <a href="https://www.brandongettyphoto.com" target="_blank" rel="noopener">Brandon Getty</a></div>
</div>

<!-- Control panel -->
<div id="controls">
  <button class="ctrl-btn ctrl-zoom" id="ctrl-zoom-in" title="Zoom in">+</button>
  <button class="ctrl-btn ctrl-zoom" id="ctrl-zoom-out" title="Zoom out">&minus;</button>

  <div class="ctrl-sep"></div>

  <button class="ctrl-btn" id="ctrl-theme" title="Toggle light/dark">
    <span id="theme-icon" class="ctrl-theme-icon">&#9788;</span>
  </button>

  <div class="ctrl-sep"></div>

  <div class="info-tooltip-wrap">
    <button class="ctrl-btn" id="ctrl-info" title="About this project">Info</button>
    <div class="info-card" id="info-card">
      <p>Ongoing work about my hometown of Stockton, California. 2010–?</p>
      <p>Best viewed on desktop.</p>
    </div>
  </div>

  <button class="ctrl-btn" id="ctrl-years" title="Filter by year">Years</button>
  <div id="years-panel">
    <button class="year-btn active" data-year="all">All</button>
    <button class="year-btn" data-year="2010">2010</button>
    <button class="year-btn" data-year="2011">2011</button>
    <button class="year-btn" data-year="2012">2012</button>
    <button class="year-btn" data-year="2013">2013</button>
    <button class="year-btn" data-year="2014">2014</button>
    <button class="year-btn" data-year="2015">2015</button>
    <button class="year-btn" data-year="2019">2019</button>
    <button class="year-btn" data-year="2022">2022</button>
  </div>
  <button class="ctrl-btn ctrl-last" id="ctrl-random" title="Random photo">Random</button>
</div>

<!-- Map -->
<div id="map"></div>

<!-- Photo panel -->
<div id="photo-panel">
  <button id="panel-close" aria-label="Close panel">&#x2715;</button>
  <button class="panel-nav" id="nav-prev" aria-label="Previous photo">&#x2039;</button>
  <button class="panel-nav" id="nav-next" aria-label="Next photo">&#x203A;</button>
  <div id="panel-tabs">
    <button class="panel-tab active" data-tab="photo">Photograph · Then</button>
    <button class="panel-tab" data-tab="streetview">Street View · Now</button>
  </div>
  <div id="panel-body">
    <div id="photo-view" class="panel-view active">
      <img id="panel-photo" src="" alt="" />
      <div id="photo-caption">
        <div class="location-name" id="caption-location"></div>
        <div class="photo-date" id="caption-date"></div>
        <div class="photo-tags" id="caption-tags"></div>
        <a class="tumblr-link" id="caption-tumblr" href="#" target="_blank" rel="noopener">View on Tumblr</a>
      </div>
    </div>
    <div id="streetview-view" class="panel-view">
      <div id="streetview-placeholder">
        <div class="icon">&#x1F6F0;</div>
        <p id="streetview-msg">
          Street View requires a Google Maps API key.<br><br>
          Set the <code>GOOGLE_API_KEY</code> variable in source to enable.
        </p>
      </div>
      <iframe id="streetview-frame" style="display:none;" loading="lazy"></iframe>
    </div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════
//  CONFIG
// ═══════════════════════════════════════════
const GOOGLE_API_KEY = 'AIzaSyB2y9l_4rZzinNZoH5SmijIK6NPpO3DCcs';

// ═══════════════════════════════════════════
//  PHOTO DATA (loaded from photos.json)
// ═══════════════════════════════════════════
let PHOTOS = [];
let appInitialized = false;

function initializeApp() {
  if (appInitialized) return;
  appInitialized = true;

// ═══════════════════════════════════════════
//  MAP SETUP
// ═══════════════════════════════════════════
const STOCKTON = [37.9577, -121.2908];

const darkLayer = L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
  { attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 19 }
);
const lightLayer = L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
  { attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 19 }
);

let isDark = true;

const map = L.map('map', {
  center: STOCKTON,
  zoom: 14,
  layers: [darkLayer],
  zoomControl: false,
});

// ═══════════════════════════════════════════
//  CONTROLS
// ═══════════════════════════════════════════
document.getElementById('ctrl-zoom-in').addEventListener('click', () => map.zoomIn());
document.getElementById('ctrl-zoom-out').addEventListener('click', () => map.zoomOut());

const themeIcon = document.getElementById('theme-icon');
document.getElementById('ctrl-theme').addEventListener('click', () => {
  if (isDark) {
    map.removeLayer(darkLayer);
    map.addLayer(lightLayer);
    themeIcon.innerHTML = '&#9790;';
  } else {
    map.removeLayer(lightLayer);
    map.addLayer(darkLayer);
    themeIcon.innerHTML = '&#9788;';
  }
  isDark = !isDark;
});

// Info tooltip
const infoBtn = document.getElementById('ctrl-info');
const infoCard = document.getElementById('info-card');
infoBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  infoCard.classList.toggle('visible');
});
document.addEventListener('click', (e) => {
  if (!infoCard.contains(e.target) && e.target !== infoBtn) {
    infoCard.classList.remove('visible');
  }
});

const yearsPanel = document.getElementById('years-panel');
document.getElementById('ctrl-years').addEventListener('click', () => {
  yearsPanel.classList.toggle('open');
});

// ═══════════════════════════════════════════
//  MARKERS & CLUSTERING
// ═══════════════════════════════════════════
const clusterGroup = L.markerClusterGroup({
  maxClusterRadius: 35,
  spiderfyOnMaxZoom: true,
  showCoverageOnHover: false,
  zoomToBoundsOnClick: true,
  iconCreateFunction: function(cluster) {
    const count = cluster.getChildCount();
    let size = 'small';
    if (count > 10) size = 'medium';
    if (count > 30) size = 'large';
    return L.divIcon({
      html: '<div>' + count + '</div>',
      className: 'marker-cluster marker-cluster-' + size,
      iconSize: L.point(36, 36)
    });
  }
});

let activeMarkerEl = null;
const markerMap = new Map();
let visiblePhotos = [...PHOTOS];

function createMarkers(photos) {
  clusterGroup.clearLayers();
  markerMap.clear();

  photos.forEach(photo => {
    const icon = L.divIcon({
      className: '',
      html: '<div class="photo-marker" data-id="' + photo.id + '"></div>',
      iconSize: [10, 10],
      iconAnchor: [5, 5]
    });

    const marker = L.marker([photo.lat, photo.lng], { icon })
      .bindTooltip(photo.title + (photo.date ? ', ' + photo.date : ''), {
        className: 'photo-tooltip',
        direction: 'top',
        offset: [0, -8]
      });

    marker.on('click', () => openPanel(photo));
    clusterGroup.addLayer(marker);
    markerMap.set(photo.id, { marker, photo });
  });

  map.addLayer(clusterGroup);
}

// ═══════════════════════════════════════════
//  YEAR FILTER
// ═══════════════════════════════════════════
function getYear(dateStr) {
  if (!dateStr) return null;
  const match = dateStr.match(/(\d{4})/);
  return match ? match[1] : null;
}

function getYearNum(dateStr) {
  const y = getYear(dateStr);
  return y ? parseInt(y) : 9999;
}

document.querySelectorAll('.year-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.year-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const year = btn.dataset.year;
    if (year === 'all') {
      visiblePhotos = [...PHOTOS];
    } else {
      visiblePhotos = PHOTOS.filter(p => getYear(p.date) === year);
    }
    createMarkers(visiblePhotos);
    closePanel();
  });
});

// Random button
document.getElementById('ctrl-random').addEventListener('click', () => {
  if (visiblePhotos.length === 0) return;
  const idx = Math.floor(Math.random() * visiblePhotos.length);
  openPanel(visiblePhotos[idx]);
});

// ═══════════════════════════════════════════
//  NAV HISTORY (random shuffle with back)
// ═══════════════════════════════════════════
let navHistory = [];     // stack of photo ids we've visited
let navHistoryIdx = -1;  // current position in history

function pushNavHistory(photo) {
  // If we're in the middle of history (user went back), truncate forward
  if (navHistoryIdx < navHistory.length - 1) {
    navHistory = navHistory.slice(0, navHistoryIdx + 1);
  }
  navHistory.push(photo.id);
  navHistoryIdx = navHistory.length - 1;
}

function getRandomPhoto(excludeId) {
  if (visiblePhotos.length <= 1) return visiblePhotos[0] || null;
  let attempts = 0;
  let photo;
  do {
    photo = visiblePhotos[Math.floor(Math.random() * visiblePhotos.length)];
    attempts++;
  } while (photo.id === excludeId && attempts < 20);
  return photo;
}

// ═══════════════════════════════════════════
//  PANEL
// ═══════════════════════════════════════════
const panel = document.getElementById('photo-panel');
const panelPhoto = document.getElementById('panel-photo');
const captionLocation = document.getElementById('caption-location');
const captionDate = document.getElementById('caption-date');
const captionTags = document.getElementById('caption-tags');
const captionTumblr = document.getElementById('caption-tumblr');
const streetviewFrame = document.getElementById('streetview-frame');
const streetviewPlaceholder = document.getElementById('streetview-placeholder');

let currentPhoto = null;

function highlightMarker(photo) {
  if (activeMarkerEl) activeMarkerEl.classList.remove('active');
  activeMarkerEl = null;
  const entry = markerMap.get(photo.id);
  if (entry) {
    const el = entry.marker.getElement();
    if (el) {
      const dot = el.querySelector('.photo-marker');
      if (dot) { dot.classList.add('active'); activeMarkerEl = dot; }
    }
  }
}

function openPanel(photo, opts = {}) {
  const wasOpen = panel.classList.contains('open');
  const isNav = opts.fromNav || false;
  const skipHistory = opts.skipHistory || false;
  currentPhoto = photo;

  // Track in nav history
  if (!skipHistory) {
    pushNavHistory(photo);
  }

  // Highlight marker
  highlightMarker(photo);

  // Photo — fade during load
  panelPhoto.classList.add('loading');
  const newImg = new Image();
  newImg.onload = () => {
    panelPhoto.src = photo.imageUrl;
    panelPhoto.alt = photo.title;
    panelPhoto.classList.remove('loading');
  };
  newImg.onerror = () => {
    panelPhoto.src = photo.imageUrl;
    panelPhoto.classList.remove('loading');
  };
  newImg.src = photo.imageUrl;

  // Caption
  captionLocation.textContent = photo.title;
  captionDate.textContent = photo.date || '';
  captionTags.textContent = photo.tags.length ? photo.tags.map(t => '#' + t).join('  ') : '';
  if (photo.tumblrUrl) {
    captionTumblr.href = photo.tumblrUrl;
    captionTumblr.style.display = 'inline-block';
  } else {
    captionTumblr.style.display = 'none';
  }

  // Scroll photo view back to top
  document.getElementById('photo-view').scrollTop = 0;

  // Street View
  if (!isNav) {
    if (GOOGLE_API_KEY) {
      streetviewPlaceholder.style.display = 'none';
      streetviewFrame.style.display = 'block';
      const h = photo.heading != null ? photo.heading : 0;
      const p = photo.pitch != null ? photo.pitch : 0;
      const f = photo.fov != null ? photo.fov : 90;
      streetviewFrame.src = 'https://www.google.com/maps/embed/v1/streetview?key=' + GOOGLE_API_KEY + '&location=' + photo.lat + ',' + photo.lng + '&heading=' + h + '&pitch=' + p + '&fov=' + f;
    } else {
      streetviewFrame.style.display = 'none';
      streetviewPlaceholder.style.display = 'flex';
    }
  }

  // Open panel & resize map
  if (!wasOpen) switchTab('photo');
  panel.classList.add('open');
  document.body.classList.add('panel-open');

  // Invalidate map size after transition, then pan
  setTimeout(() => {
    map.invalidateSize({ animate: true });
    setTimeout(() => map.panTo([photo.lat, photo.lng], { animate: true }), 100);
  }, isNav ? 50 : 480);

  if (isNav) {
    // Debounced SV reload during rapid nav
    clearTimeout(openPanel._svTimer);
    openPanel._svTimer = setTimeout(() => {
      if (GOOGLE_API_KEY && currentPhoto) {
        streetviewPlaceholder.style.display = 'none';
        streetviewFrame.style.display = 'block';
        const h2 = currentPhoto.heading != null ? currentPhoto.heading : 0;
        const p2 = currentPhoto.pitch != null ? currentPhoto.pitch : 0;
        const f2 = currentPhoto.fov != null ? currentPhoto.fov : 90;
        streetviewFrame.src = 'https://www.google.com/maps/embed/v1/streetview?key=' + GOOGLE_API_KEY + '&location=' + currentPhoto.lat + ',' + currentPhoto.lng + '&heading=' + h2 + '&pitch=' + p2 + '&fov=' + f2;
      }
    }, 400);
  }
}

function closePanel() {
  panel.classList.remove('open');
  document.body.classList.remove('panel-open');
  if (activeMarkerEl) { activeMarkerEl.classList.remove('active'); activeMarkerEl = null; }
  currentPhoto = null;
  streetviewFrame.src = '';
  // Re-invalidate map to fill viewport
  setTimeout(() => map.invalidateSize({ animate: true }), 480);
}

// Close events
document.getElementById('panel-close').addEventListener('click', closePanel);
document.addEventListener('keydown', e => { if (e.key === 'Escape') closePanel(); });
map.on('click', e => {
  if (panel.classList.contains('open') && !e.originalEvent?.target?.closest('.photo-marker')) closePanel();
});

// Nav — "next" is random, "prev" goes back in history
function navigateNext() {
  if (!currentPhoto || visiblePhotos.length === 0) return;
  // If we've gone back and there's forward history, go forward
  if (navHistoryIdx < navHistory.length - 1) {
    navHistoryIdx++;
    const nextId = navHistory[navHistoryIdx];
    const entry = markerMap.get(nextId);
    if (entry) {
      openPanel(entry.photo, { fromNav: true, skipHistory: true });
      return;
    }
  }
  // Otherwise pick a random photo
  const next = getRandomPhoto(currentPhoto.id);
  if (next) openPanel(next, { fromNav: true });
}

function navigatePrev() {
  if (!currentPhoto) return;
  if (navHistoryIdx > 0) {
    navHistoryIdx--;
    const prevId = navHistory[navHistoryIdx];
    const entry = markerMap.get(prevId);
    if (entry) {
      openPanel(entry.photo, { fromNav: true, skipHistory: true });
    }
  }
}

document.getElementById('nav-prev').addEventListener('click', () => navigatePrev());
document.getElementById('nav-next').addEventListener('click', () => navigateNext());
document.addEventListener('keydown', e => {
  if (!currentPhoto) return;
  if (e.key === 'ArrowRight' || e.key === 'ArrowDown') { e.preventDefault(); navigateNext(); }
  if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') { e.preventDefault(); navigatePrev(); }
});

// Tabs
function switchTab(name) {
  document.querySelectorAll('.panel-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === name));
  document.querySelectorAll('.panel-view').forEach(v => v.classList.toggle('active', v.id === name + '-view'));
}
document.querySelectorAll('.panel-tab').forEach(t => t.addEventListener('click', () => switchTab(t.dataset.tab)));

// ═══════════════════════════════════════════
//  INIT
// ═══════════════════════════════════════════
createMarkers(PHOTOS);
visiblePhotos = [...PHOTOS];

// Open a random photo on first visit
if (PHOTOS.length > 0) {
  const randomIdx = Math.floor(Math.random() * PHOTOS.length);
  setTimeout(() => openPanel(PHOTOS[randomIdx]), 1200);
}

  // Dismiss loading
  setTimeout(() => document.getElementById('loading').classList.add('done'), 800);
  setTimeout(() => document.getElementById('loading').remove(), 1500);
}

fetch('photos.json')
  .then(r => r.json())
  .then(data => {
    PHOTOS = data;
    initializeApp();
  })
  .catch(err => {
    console.error('Failed to load photo data:', err);
    setTimeout(() => document.getElementById('loading').classList.add('done'), 800);
    setTimeout(() => document.getElementById('loading').remove(), 1500);
  });

</script>
</body>
</html>
